on:
  workflow_dispatch:
    inputs: {}
jobs:
  gcs_source_archive_bucket_upload:
    runs-on: ubuntu-latest
    env:
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      SOURCE_ARCHIVE_BUCKET_NAME: ${{ secrets.SOURCE_ARCHIVE_BUCKET_NAME }}
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: setup gcloud
        uses: google-github-actions/setup-gcloud@master
        with:
          service_account_key: ${{ env.GCP_SERVICE_ACCOUNT_KEY }}
          export_default_credentials: true
      - name: zip nodejs12 cloud functions
        run: |
          current_dir=$(pwd)
          NODEJS12_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH="${current_dir}/${GITHUB_SHA}/nodejs12"
          mkdir -p "${NODEJS12_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH}"
          find nodejs12 -maxdepth 1 -mindepth 1 -type d | while read function_path; do
            function_name="$(echo ${function_path} | rev | cut -d'/' -f 1 | rev)"
            cd "${function_path}"
            zip -r "${NODEJS12_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH}/${function_name}.zip" *
            cd "${current_dir}"
          done
          echo "NODEJS12_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH=${NODEJS12_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH}" >> "${GITHUB_ENV}"
      - name: upload nodejs12 cloud functions
        uses: google-github-actions/upload-cloud-storage@main
        with:
          path: ${{ env.NODEJS12_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH }}
          destination: ${{ env.SOURCE_ARCHIVE_BUCKET_NAME }}/${{ github.sha }}
          gzip: false
      - name: zip python38 cloud functions
        run: |
          current_dir=$(pwd)
          PYTHON38_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH="${current_dir}/${GITHUB_SHA}/python38"
          mkdir -p "${PYTHON38_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH}"
          find python38 -maxdepth 1 -mindepth 1 -type d | while read function_path; do
            function_name="$(echo ${function_path} | rev | cut -d'/' -f 1 | rev)"
            cd "${function_path}"
            zip -r "${PYTHON38_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH}/${function_name}.zip" *
            cd "${current_dir}"
          done
          echo "PYTHON38_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH=${PYTHON38_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH}" >> "${GITHUB_ENV}"
      - name: upload python38 cloud functions
        uses: google-github-actions/upload-cloud-storage@main
        with:
          path: ${{ env.PYTHON38_SOURCE_ARCHIVE_BUCKET_OBJECT_PATH }}
          destination: ${{ env.SOURCE_ARCHIVE_BUCKET_NAME }}/${{ github.sha }}
          gzip: false
      - name: run monorepo github_actions_workflow_dispatch_terragrunt_run_all_apply script
        run: ./bash/github-actions/workflow_dispatch_terragrunt_run_all.sh "$GH_USER_TOKEN" "main" "./live/gcs/non-prod" "apply" "true" "true" "true" "true" "true"
