on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: cluster_name
        required: true
      cluster_location:
        description: cluster_location
        required: true
      cluster_project:
        description: cluster_project
        required: true
jobs:
  terragrunt:
    runs-on: ubuntu-latest
    env:
      GITHUB_ACTIONS_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      GITHUB_NAME: ${{ secrets.GH_USERNAME }}
      GITHUB_EMAIL: ${{ secrets.GH_EMAIL }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    steps:
      - id: run_checkout
        name: run checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
      - id: run_event_start
        name: run event start
        run: bash "${GITHUB_WORKSPACE}/bash/github/event.sh" "start"
      - id: run_setup_git
        name: run setup git
        run: bash "${GITHUB_WORKSPACE}/bash/github/setup_git.sh"
      - id: run_setup_github_path
        name: run setup github path
        run: mkdir -p "${HOME}/.local/bin" && echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - id: run_setup_kubectl
        name: run setup kubectl
        run: bash bash/kubernetes/setup_kubectl_linux.sh
      - id: run_setup_kustomize
        name: run setup kustomize
        run: bash bash/kubernetes/setup_kustomize.sh
      - id: run_setup_flux
        name: run setup flux
        run: bash bash/kubernetes/setup_flux.sh
      - id: run_setup_gcloud
        name: run setup gcloud
        uses: google-github-actions/setup-gcloud@master
        with:
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          export_default_credentials: true
      - id: run_setup_kubectx
        name: run setup kubectx
        env:
          CLUSTER_NAME: ${{ github.event.inputs.cluster_name }}
          CLUSTER_PROJECT: ${{ github.event.inputs.cluster_project }}
          CLUSTER_LOCATION: ${{ github.event.inputs.cluster_location }}
        run: bash "${GITHUB_WORKSPACE}/bash/kubernetes/setup_kubectx.sh"
      - id: run_kustomize_build_kubectl_apply
        name: run kustomize build kubectl apply
        env:
          CLUSTER_KUSTOMIZE_PATH: ${{ github.workspace }}/kustomize/manifests/deploy/overlays/${{ github.event.inputs.cluster_project }}
        run: bash "${GITHUB_WORKSPACE}/bash/kubernetes/kustomize_build_kubectl_apply.sh"
      - id: run_flux_reconcile
        name: run flux reconcile
        run: |
          pip install -r "${GITHUB_WORKSPACE}/python/kubernetes/requirements.txt"
          python "${GITHUB_WORKSPACE}/python/kubernetes/main.py" \
            --command "flux_reconcile" \
            --args "{ \"github_sha\": \"${GITHUB_SHA}\" }"
      - id: run_event_success
        name: run event success
        if: ${{ success() }}
        run: bash "${GITHUB_WORKSPACE}/bash/github/event.sh" "success"
      - id: run_event_failure
        name: run event failure
        if: ${{ failure() }}
        run: bash "${GITHUB_WORKSPACE}/bash/github/event.sh" "failure"
